<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Food Guide</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #fff;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* helper class used by server-side rendering to hide elements */
        .hidden { display: none !important; }

        nav {
            background: linear-gradient(135deg, #111, #222);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #ff9800;
            text-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .logo:hover {
            transform: scale(1.05);
            text-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-btn {
            background: transparent;
            border: 2px solid #ff9800;
            color: #ff9800;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-btn:hover {
            background: #ff9800;
            color: #000;
            transform: translateY(-2px);
        }

        .auth button {
            border: none;
            background: linear-gradient(135deg, #ff9800, #ff6f00);
            color: #000;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .auth button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
            background: linear-gradient(135deg, #ffb74d, #ff8f00);
        }

        .profile-img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #ff9800;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-img:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .hero {
            text-align: center;
            margin-bottom: 60px;
            padding: 40px 0;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #ff9800, #4caf50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.2rem;
            color: #ccc;
            max-width: 600px;
            margin: 0 auto;
        }

        .canteen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .canteen-card {
            background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .canteen-card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: 0 20px 40px rgba(255, 152, 0, 0.2);
        }

        .canteen-card img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .canteen-card:hover img {
            transform: scale(1.1);
        }

        .card-content {
            padding: 25px;
            position: relative;
            z-index: 2;
        }

        .card-content h3 {
            font-size: 1.5rem;
            color: #ff9800;
            margin-bottom: 10px;
            text-align: center;
        }

        .card-content p {
            color: #ccc;
            text-align: center;
            font-size: 0.9rem;
        }

        .upload-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800, #ff6f00);
            color: #000;
            font-size: 28px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .upload-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 30px rgba(255, 152, 0, 0.6);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal-content {
            background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
            margin: 20px auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
            position: relative;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #ff9800;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ff9800;
            font-weight: bold;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            border-radius: 10px;
            background: #222;
            color: #fff;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
        }

        .rating-stars {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            justify-content: center;
        }

        .star {
            font-size: 28px;
            color: #333;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .star:hover, .star.active {
            color: #ff9800;
        }

        .spice-level {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            justify-content: center;
        }

        .chili {
            font-size: 24px;
            cursor: pointer;
            filter: grayscale(100%);
            transition: filter 0.2s ease;
        }

        .chili.active {
            filter: grayscale(0%);
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ff9800, #ff6f00);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4);
        }

        .auth-tabs {
            display: flex;
            justify-content: center;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 0;
            background: transparent;
            color: #ccc;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #ff9800;
            border-bottom-color: #ff9800;
        }

        .canteen-page {
            display: none;
        }

        .canteen-header {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .canteen-title {
            font-size: 2.5rem;
            color: #ff9800;
            margin-bottom: 20px;
            text-align: center;
        }

        .filter-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-dropdown {
            padding: 12px 20px;
            background: #333;
            color: #fff;
            border: 2px solid #555;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-dropdown:hover, .filter-dropdown:focus {
            border-color: #ff9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
            outline: none;
        }

        .posts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .post-card {
            background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .post-card:hover {
            transform: translateY(-5px);
        }

        .post-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .post-content {
            padding: 20px;
        }

        .post-title {
            font-size: 1.3rem;
            color: #ff9800;
            margin-bottom: 10px;
        }

        .post-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #ccc;
        }

        .post-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }

        .action-btn {
            background: #333;
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            background: #4caf50;
            transform: scale(1.05);
        }

        .action-btn.upvoted {
            background: #4caf50;
        }

        .action-btn.favorited {
            background: #ff9800;
            color: #000;
        }

        .comment-btn {
            background: #2196F3;
        }

        .comment-btn:hover {
            background: #1976D2;
        }

        .comments-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #333;
            display: none;
        }

        .comment-item {
            background: #222;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .comment-author {
            color: #ff9800;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .comment-text {
            color: #ccc;
            font-size: 0.85rem;
        }

        .comment-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .comment-input {
            flex: 1;
            padding: 10px;
            background: #222;
            border: 2px solid #333;
            border-radius: 8px;
            color: #fff;
        }

        .comment-input:focus {
            outline: none;
            border-color: #ff9800;
        }

        .profile-page {
            display: none;
        }

        .profile-header {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid #ff9800;
            /* margin: 0 auto 20px; */
            object-fit: cover;
        }

        .profile-name {
            font-size: 2rem;
            color: #ff9800;
            margin-bottom: 10px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-box {
            background: #222;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            color: #ff9800;
            font-weight: bold;
        }

        .stat-label {
            color: #ccc;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .profile-tabs {
            display: flex;
            gap: 10px;
            margin: 30px 0;
            border-bottom: 2px solid #333;
        }

        .profile-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #ccc;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
        }

        .profile-tab.active {
            color: #ff9800;
            border-bottom-color: #ff9800;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }

            .canteen-grid {
                grid-template-columns: 1fr;
            }

            nav {
                padding: 10px 15px;
            }

            .nav-menu {
                gap: 10px;
            }

            .nav-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .posts-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 3000;
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
            min-width: 220px;
            max-width: 360px;
            background: rgba(30,30,30,0.95);
            color: #fff;
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateY(-6px);
            transition: opacity 180ms ease, transform 180ms ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success { background: linear-gradient(90deg,#4caf50,#2e7d32); }
        .toast.error   { background: linear-gradient(90deg,#f44336,#c62828); }
        .toast.warning { background: linear-gradient(90deg,#ff9800,#ff6f00); }
        .toast.info    { background: linear-gradient(90deg,#2196f3,#1565c0); }
    </style>
</head>
<body>
    <nav>
        <div class="logo" onclick="showHomePage()">üçΩÔ∏è Campus Food Guide</div>
        <div class="nav-menu">
            <button class="nav-btn {% if not logged_in %}hidden{% endif %}" id="myProfileBtn" onclick="showProfile()">My Profile</button>
            <button class="nav-btn {% if not logged_in %}hidden{% endif %}" id="favoritesBtn" onclick="showFavorites()">Favorites</button>
            <div class="auth">
                <button id="authBtn" onclick="toggleAuth()" class="{% if logged_in %}hidden{% endif %}">Sign In</button>
                <img id="profileImg" src="{{ profile_image_url if profile_image_url else 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT1pEdTSj3BgYH3tqCYYV9nSOa8kPt7Jn40HA&s' }}" alt="Profile" class="profile-img {% if not logged_in %}hidden{% endif %}">
            </div>
        </div>
    </nav>

    <div id="mainPage">
        <div class="container">
            <div class="hero">
                <h1>Discover Campus Flavors</h1>
                <p>Your ultimate guide to campus dining. Share reviews, discover new foods, and connect with fellow food lovers.</p>
            </div>

            <div class="canteen-grid">
                <div class="canteen-card" onclick="openCanteen('Pixel Canteen', 1)">
                    <img src="/templates/public/PIXEL.png" alt="Pixel Canteen">
                    <div class="card-content">
                        <h3>Pixel Canteen</h3>
                        <p>Affordable and delicious local cuisine</p>
                    </div>
                </div>
                <div class="canteen-card" onclick="openCanteen('4th Floor Cafeteria', 2)">
                    <img src="/templates/public/4TH_FLOOR.png" alt="4th Floor Cafeteria">
                    <div class="card-content">
                        <h3>4th Floor Cafeteria</h3>
                        <p>Street food paradise with authentic tastes</p>
                    </div>
                </div>
                
                <div class="canteen-card" onclick="openCanteen('5th Floor Cafeteria', 3)">
                    <img src="/templates/public/5TH_FLOOR.png" alt="5th Floor Cafeteria">
                    <div class="card-content">
                        <h3>5th Floor Cafeteria</h3>
                        <p> Quick bites and beverages for study sessions</p>
                    </div>
                </div>
                
                <div class="canteen-card" onclick="openCanteen('MRD Canteen', 4)">
                    <img src="/templates/public/mrd.png" alt="MRD Canteen">
                    <div class="card-content">
                        <h3>MRD Canteen</h3>
                        <p>Traditional Indian cuisine with modern twists</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="canteenPage" class="canteen-page">
        <div class="container">
            <div class="canteen-header">
                <h1 id="canteenTitle" class="canteen-title">Canteen Name</h1>
                <div class="filter-bar">
                    <select class="filter-dropdown" id="sortFilter">
                    <option value="">Sort by</option>
                    <option value="upvotes">Most Upvotes</option>
                    <option value="popular">Most Popular</option>
                    <option value="spice">Spice Level (High to Low)</option>
                    <option value="recent">Newest First</option>
                    <option value="price_low">Price (Low to High)</option>
                </select>
                    <button class="submit-btn" style="width: auto; padding: 10px 20px;" onclick="goBack()">‚Üê Back to Main</button>
                </div>
            </div>

            <div class="posts-grid" id="postsGrid"></div>
        </div>
    </div>

    <div id="profilePage" class="profile-page">
        <div class="container">
            <div class="profile-header">
                <div style="position: relative; display: inline-block; margin-bottom: 20px;">
                    <img id="profileAvatar" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT1pEdTSj3BgYH3tqCYYV9nSOa8kPt7Jn40HA&s" alt="Profile" class="profile-avatar">
                    
                    <input type="file" id="changeProfilePicInput" accept="image/*" style="display: none;">
                    
                    <button onclick="document.getElementById('changeProfilePicInput').click()" style="position: absolute; bottom: 0; right: 0; background: #ff9800; color: #000; border: 2px solid #000; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; line-height: 1; display: flex; align-items: center; justify-content: center; transform: translate(5px, 5px);">
                        &#9998;
                    </button>
                </div>
                <h1 class="profile-name" id="profileName">User Name</h1>
                <p style="color: #ccc;" id="profileEmail">user@example.com</p>
                
                <div class="profile-stats">
                    <div class="stat-box">
                        <div class="stat-number" id="statPosts">0</div>
                        <div class="stat-label">Reviews</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="statUpvotes">0</div>
                        <div class="stat-label">Upvotes Received</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="statFavorites">0</div>
                        <div class="stat-label">Favorites</div>
                    </div>
                </div>
            </div>

            <div class="profile-tabs">
                <button class="profile-tab active" onclick="switchProfileTab('myPosts')">My Reviews</button>
                <button class="profile-tab" onclick="switchProfileTab('myFavorites')">My Favorites</button>
                <button class="profile-tab" onclick="switchProfileTab('upvoted')">Upvoted</button>
            </div>

            <div id="myPosts" class="tab-content active">
                <div class="posts-grid" id="myPostsGrid"></div>
            </div>

            <div id="myFavorites" class="tab-content">
                <div class="posts-grid" id="myFavoritesGrid"></div>
            </div>

            <div id="upvoted" class="tab-content">
                <div class="posts-grid" id="upvotedGrid"></div>
            </div>

            <button class="submit-btn" style="width: auto; padding: 10px 20px; margin-top: 20px;" onclick="showHomePage()">‚Üê Back to Main</button>
        </div>
    </div>

    <div class="upload-btn" id="uploadBtn" onclick="openUploadModal()" title="Add new review" style="display: none;">+</div>

    <div id="authModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="closeAuthModal()">&times;</span>
            <h2 id="authTitle" style="color: #ff9800; margin-bottom: 25px; text-align: center;">Sign In</h2>
            
            <div class="auth-tabs" style="display: flex; margin-bottom: 25px; border-bottom: 2px solid #333;">
                <button class="tab-btn active" onclick="switchAuthTab('signin')" id="signinTab">Sign In</button>
                <button class="tab-btn" onclick="switchAuthTab('register')" id="registerTab">Register</button>
            </div>

            <form id="signinForm" class="auth-form" action="/login" method="post">
                <div class="form-group">
                    <label for="signinEmail">Email/Username</label>
                    <input type="text" id="signinEmail" name="identifier" placeholder="Enter your email or username" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="signinPassword">Password</label>
                   <input type="password" id="signinPassword" name="password" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                
                <div class="form-group" style="display: flex; align-items: center; gap: 8px; margin-bottom: 25px;">
                    <input type="checkbox" id="rememberMe" style="width: auto; margin: 0;">
                    <label for="rememberMe" style="color: #ccc; font-size: 14px; margin: 0;">Remember me</label>
                </div>
                
                <button type="submit" class="submit-btn">Sign In</button>
                
                <p style="text-align: center; margin-top: 15px; color: #ccc; font-size: 14px;">
                    Don't have an account? 
                    <span style="color: #ff9800; cursor: pointer; text-decoration: underline;" onclick="switchAuthTab('register')">Register here</span>
                </p>
            </form>

            <form id="registerForm" class="auth-form" style="display: none;" action="/register" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" name="full_name" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" name="email" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="registerUsername">Username</label>
                    <input type="text" id="registerUsername" name="username" placeholder="Choose a username" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" name="password" placeholder="Create a password" required autocomplete="new-password">
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password" required autocomplete="new-password">
                </div>
                
                <div class="form-group">
                    <label for="studentId">Student ID (Optional)</label>
                    <input type="text" id="studentId" name="student_id" placeholder="Enter your student ID">
                </div>
                
                <div class="form-group">
                    <label for="profilePic">Profile Picture (Optional)</label>
                    <input type="file" id="profilePic" name="profile_pic" accept="image/*">
                </div>
                <div class="form-group" style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 25px;">
                    <input type="checkbox" id="agreeTerms" style="width: auto; margin: 0; margin-top: 4px;" required>
                    <label for="agreeTerms" style="color: #ccc; font-size: 14px; margin: 0; line-height: 1.4;">
                        I agree to the Terms of Service and Privacy Policy
                    </label>
                </div>
                
                <button type="submit" class="submit-btn">Register</button>
                
                <p style="text-align: center; margin-top: 15px; color: #ccc; font-size: 14px;">
                    Already have an account? 
                    <span style="color: #ff9800; cursor: pointer; text-decoration: underline;" onclick="switchAuthTab('signin')">Sign in here</span>
                </p>
            </form>
        </div>
    </div>
    
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUploadModal()">&times;</span>
            <h2 style="color: #ff9800; margin-bottom: 25px; text-align: center;">Add Food Review</h2>
            
            <form id="uploadForm" action="/submit_review" method="POST" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="foodName">Food Name *</label>
                    <input type="text" id="foodName" name="food_name" placeholder="Enter food name" required>
                </div>
                
                <div class="form-group">
                    <label for="price">Price (‚Çπ) *</label>
                    <input type="number" id="price" name="price" placeholder="Enter price" required>
                </div>
                
                <div class="form-group">
                    <label>Rating *</label>
                    <div class="rating-stars" id="ratingStars">
                        <span class="star" data-rating="1">‚òÜ</span>
                        <span class="star" data-rating="2">‚òÜ</span>
                        <span class="star" data-rating="3">‚òÜ</span>
                        <span class="star" data-rating="4">‚òÜ</span>
                        <span class="star" data-rating="5">‚òÜ</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Spice Level</label>
                    <div class="spice-level">
                        <span class="chili" data-spice="1">üå∂Ô∏è</span>
                        <span class="chili" data-spice="2">üå∂Ô∏è</span>
                        <span class="chili" data-spice="3">üå∂Ô∏è</span>
                        <span class="chili" data-spice="4">üå∂Ô∏è</span>
                        <span class="chili" data-spice="5">üå∂Ô∏è</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="review">Review</label>
                    <textarea id="review" name="review" rows="4" placeholder="Share your experience..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="foodImage">Upload Images (Max 5)</label>
                    <input type="file" id="foodImage" name="images" accept="image/*" multiple>
                    <div id="imagePreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px;"></div>
                </div>

                <!-- Hidden inputs populated by JS before submit -->
                <input type="hidden" id="ratingInput" name="rating" value="0">
                <input type="hidden" id="spiceInput" name="spice_level" value="0">
                <input type="hidden" id="canteenIdInput" name="canteen_id" value="">

                <button type="submit" class="submit-btn">Submit Review</button>
            </form>
        </div>
    </div>


        <script>
            // Client-side state defaults ‚Äî declared before server-data so server can safely
            // initialize these without hitting the temporal-dead-zone for `let` variables.
            let currentRating = 0;
            let currentSpiceLevel = 0;
            let isLoggedIn = false;
            let currentCanteen = '';
            let currentCanteenId = null;
            let currentUser = {
                id: null,
                username: '',
                email: '',
                fullName: '',
                myPosts: [],
                favorites: [],
                upvotedPosts: [],
                // Default profile picture URL
                profilePic: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT1pEdTSj3BgYH3tqCYYV9nSOa8kPt7Jn40HA&s"
            };

        </script>

        <script id="server-data" type="application/json">
        {
            "loggedIn": {{ logged_in|default(false)|tojson }},
            "showProfile": {{ show_profile|default(false)|tojson }},
            "showCanteen": {{ show_canteen|default(false)|tojson }},
            "canteenId": {{ canteen_id|default(None)|tojson }},
            "canteenName": {{ canteen_name|default('')|tojson }},
            "username": {{ username|default('')|tojson }},
            "profileImageUrl": {{ profile_image_url|default('')|tojson }},
            "user_id": {{ user_id|default(None)|tojson }},
            "email": {{ email|default('')|tojson }}
        }
        </script>
    
        <script>
            // Parse server-provided initial state (injected by Flask) from a JSON block
            let SERVER = { loggedIn: false, showProfile: false, username: '', profileImageUrl: '' };
            try {
                const raw = document.getElementById('server-data').textContent.trim();
                if (raw) {
                    const parsed = JSON.parse(raw);
                    SERVER = Object.assign(SERVER, parsed);
                }
            } catch (e) {
                console.warn('Could not parse server-data JSON, using defaults.', e);
            }
    
            if (SERVER.loggedIn) {
                // Initialize client-side state from server
                isLoggedIn = true;
                currentUser.username = SERVER.username || currentUser.username;
                currentUser.fullName = SERVER.username || currentUser.fullName;
                currentUser.profilePic = SERVER.profileImageUrl || currentUser.profilePic;
                currentUser.id = SERVER.user_id || currentUser.id;
                currentUser.email = SERVER.email || currentUser.email;
                // Ensure UI reflects login state
                document.addEventListener('DOMContentLoaded', function() {
                    updateAuthUI();
                    if (SERVER.showProfile) {
                        showProfile();
                    }
                });
            }
            // If the server told us to open a canteen view (SPA fallback), do that.
            if (SERVER.showCanteen) {
                // set client-side canteen state from server
                currentCanteenId = SERVER.canteenId || null;
                currentCanteen = SERVER.canteenName || '';
                document.addEventListener('DOMContentLoaded', function() {
                    // Ensure auth UI is updated first (if logged in)
                    updateAuthUI();
                    // Open the canteen page which will fetch reviews via the API
                    openCanteen(currentCanteen, currentCanteenId);
                });
            }
    
        </script>
        <!-- Toast container -->
        <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
            // Toast helper: showToast(message, type='info', timeout=3500)
            function showToast(message, type = 'info', timeout = 3500) {
                try {
                    const container = document.getElementById('toast-container');
                    if (!container) return alert(message);

                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.textContent = message;

                    // add close button
                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = '√ó';
                    closeBtn.style.marginLeft = 'auto';
                    closeBtn.style.border = 'none';
                    closeBtn.style.background = 'transparent';
                    closeBtn.style.color = 'rgba(255,255,255,0.9)';
                    closeBtn.style.fontSize = '16px';
                    closeBtn.style.cursor = 'pointer';
                    closeBtn.onclick = () => { removeToast(toast); };
                    toast.appendChild(closeBtn);

                    container.appendChild(toast);

                    // force reflow then show
                    window.getComputedStyle(toast).opacity;
                    toast.classList.add('show');

                    const timer = setTimeout(() => removeToast(toast), timeout);
                    function removeToast(t) {
                        if (!t) return;
                        t.classList.remove('show');
                        setTimeout(() => { try { t.remove(); } catch(e){} }, 220);
                        clearTimeout(timer);
                    }
                } catch (e) {
                    // fallback
                    alert(message);
                }
            }
        const samplePosts = [
            {
                id: 1,
                canteen_id: 1,
                image: "https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b?w=300&h=200&fit=crop",
                name: "Margherita Pizza",
                rating: 4,
                price: 180,
                spiceLevel: 1,
                author: "Rahul Sharma",
                author_id: 1,
                upvotes: 23,
                review: "Fresh ingredients and perfect crust!",
                comments: [
                    {id: 1, author: "Priya Patel", text: "I totally agree! Best pizza on campus!", user_id: 2},
                    {id: 2, author: "Arjun Kumar", text: "Try it with extra cheese!", user_id: 3}
                ]
            },
            {
                id: 2,
                canteen_id: 1,
                image: "https://images.unsplash.com/photo-1571091718767-18b5b1457add?w=300&h=200&fit=crop",
                name: "Chicken Biryani",
                rating: 5,
                price: 220,
                spiceLevel: 4,
                author: "Priya Patel",
                author_id: 2,
                upvotes: 45,
                review: "Authentic flavors, must try!",
                comments: []
            },
            {
                id: 3,
                canteen_id: 2,
                image: "https://images.unsplash.com/photo-1551782450-a2132b4ba21d?w=300&h=200&fit=crop",
                name: "Masala Dosa",
                rating: 4,
                price: 120,
                spiceLevel: 2,
                author: "Arjun Kumar",
                author_id: 3,
                upvotes: 31,
                review: "Crispy and delicious with perfect sambar",
                comments: []
            }
        ];

        // Fetch canteens from server and render them (replaces hardcoded cards)
        async function loadCanteens() {
            try {
                const res = await fetch('/api/canteens');
                const data = await res.json();
                if (data && data.success) {
                    renderCanteens(data.canteens || []);
                } else {
                    console.warn('Could not load canteens', data);
                }
            } catch (e) {
                console.error('Error fetching canteens', e);
            }
        }

        function renderCanteens(canteens) {
            const grid = document.querySelector('.canteen-grid');
            if (!grid) return;
            // If no canteens, keep existing hardcoded content as fallback
            if (!Array.isArray(canteens) || canteens.length === 0) return;

            grid.innerHTML = '';
            canteens.forEach(c => {
                const card = document.createElement('div');
                card.className = 'canteen-card';
                card.onclick = function() { openCanteen(c.name, c.id); };

                const img = document.createElement('img');
                img.src = c.image_url || '/templates/public/PIXEL.png';
                img.alt = c.name;

                const content = document.createElement('div');
                content.className = 'card-content';

                const h3 = document.createElement('h3');
                h3.textContent = c.name;
                const p = document.createElement('p');
                p.textContent = c.description || c.location || '';

                content.appendChild(h3);
                content.appendChild(p);
                card.appendChild(img);
                card.appendChild(content);
                grid.appendChild(card);
            });
        }

        // Load canteens once DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            loadCanteens();
        });

        function toggleAuth() {
            if (isLoggedIn) {
                const confirm = window.confirm('Do you want to log out?');
                if (confirm) {
                    isLoggedIn = false;
                    currentUser = {
                        id: null,
                        username: '',
                        email: '',
                        fullName: '',
                        myPosts: [],
                        favorites: [],
                        upvotedPosts: [],
                        profilePic: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT1pEdTSj3BgYH3tqCYYV9nSOa8kPt7Jn40HA&s"
                    };
                    updateAuthUI();
                    showHomePage();
                }
            } else {
                openAuthModal();
            }
        }

        function updateAuthUI() {
            const authBtn = document.getElementById('authBtn');
            const profileImg = document.getElementById('profileImg');
            const myProfileBtn = document.getElementById('myProfileBtn');
            const favoritesBtn = document.getElementById('favoritesBtn');
            
            // Set the profile image source based on the current user data
            profileImg.src = currentUser.profilePic || "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT1pEdTSj3BgYH3tqCYYV9nSOa8kPt7Jn40HA&s";

            if (isLoggedIn) {
                authBtn.style.display = 'none';
                profileImg.style.display = 'block';
                myProfileBtn.style.display = 'block';
                favoritesBtn.style.display = 'block';
                profileImg.title = 'Click to logout';
            } else {
                authBtn.style.display = 'block';
                profileImg.style.display = 'none';
                myProfileBtn.style.display = 'none';
                favoritesBtn.style.display = 'none';
                authBtn.textContent = 'Sign In';
            }
        }

        function openAuthModal() {
            document.getElementById('authModal').style.display = 'block';
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            resetAuthForms();
        }

        function resetAuthForms() {
            document.getElementById('signinForm').reset();
            document.getElementById('registerForm').reset();
            switchAuthTab('signin');
        }

        function switchAuthTab(tab) {
            const signinTab = document.getElementById('signinTab');
            const registerTab = document.getElementById('registerTab');
            const signinForm = document.getElementById('signinForm');
            const registerForm = document.getElementById('registerForm');
            const authTitle = document.getElementById('authTitle');

            if (tab === 'signin') {
                signinTab.classList.add('active');
                registerTab.classList.remove('active');
                signinForm.style.display = 'block';
                registerForm.style.display = 'none';
                authTitle.textContent = 'Sign In';
            } else {
                registerTab.classList.add('active');
                signinTab.classList.remove('active');
                registerForm.style.display = 'block';
                signinForm.style.display = 'none';
                authTitle.textContent = 'Register';
            }
        }

        function openCanteen(canteenName, canteenId) {
            currentCanteen = canteenName;
            currentCanteenId = canteenId;

            document.getElementById('canteenTitle').textContent = canteenName;

            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('canteenPage').style.display = 'block';
            document.getElementById('profilePage').style.display = 'none';
            document.getElementById('uploadBtn').style.display = 'flex';
            loadPosts();
            // Ensure the upload form knows which canteen we're in
            const canteenInput = document.getElementById('canteenIdInput');
            if (canteenInput) canteenInput.value = canteenId;
        }

        function showHomePage() {
            document.getElementById('mainPage').style.display = 'block';
            document.getElementById('canteenPage').style.display = 'none';
            document.getElementById('profilePage').style.display = 'none';
            document.getElementById('uploadBtn').style.display = 'none';
        }

        function goBack() {
            showHomePage();
        }

        function showProfile(tabToShow = 'myPosts') {
            if (!isLoggedIn) {
                openAuthModal();
                return;
            }

            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('canteenPage').style.display = 'none';
            document.getElementById('profilePage').style.display = 'block';
            document.getElementById('uploadBtn').style.display = 'none';

            document.getElementById('profileName').textContent = currentUser.fullName;
            document.getElementById('profileEmail').textContent = currentUser.email;
            
            // Set the profile avatar on the profile page
            document.getElementById('profileAvatar').src = currentUser.profilePic || "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT1pEdTSj3BgYH3tqCYYV9nSOa8kPt7Jn40HA&s";


            // Ensure we fetch the authoritative list from server before rendering
            // Fetch /api/me and my reviews, then fetch any additional reviews referenced
            // by favorites/upvoted so we can show posts belonging to other users.
            Promise.all([
                fetch('/api/me').then(r => r.json()).catch(() => null),
                fetchMyReviews()
            ]).then(async ([meData]) => {
                if (meData && meData.logged_in) {
                    currentUser.id = meData.user_id || currentUser.id;
                    currentUser.username = meData.username || currentUser.username;
                    currentUser.profilePic = meData.profile_image_url || currentUser.profilePic;
                    currentUser.favorites = meData.favorites || [];
                    currentUser.upvotedPosts = meData.upvoted || [];
                }

                // If the user has favorites or upvoted posts (which may not be in myPosts), fetch them
                const extraIds = Array.from(new Set([...(currentUser.favorites || []), ...(currentUser.upvotedPosts || [])]));
                if (extraIds.length > 0) {
                    try {
                        const q = `/api/reviews_by_ids?ids=${extraIds.join(',')}`;
                        const res = await fetch(q);
                        const d = await res.json();
                        if (d && d.success) {
                            // merge into a lookup so loadProfilePosts can find them
                            currentUser._extraPosts = d.reviews || [];
                        } else {
                            currentUser._extraPosts = [];
                        }
                    } catch (e) {
                        console.warn('Could not fetch extra posts for profile', e);
                        currentUser._extraPosts = [];
                    }
                } else {
                    currentUser._extraPosts = [];
                }

                try { updateProfileStats(); } catch (e) {}
                try { loadProfilePosts(); } catch (e) {}
            }).catch((e) => {
                // fallback: render with whatever cached data we have
                try { updateProfileStats(); } catch (e) {}
                try { loadProfilePosts(); } catch (e) {}
            });

            // Explicitly switch to the desired tab after loading
            switchProfileTabManual(tabToShow);
        }

        function updateProfileStats() {
    // Use server-backed posts when available, fallback to empty array
    const myPosts = Array.isArray(currentUser.myPosts) ? currentUser.myPosts : [];
    const totalUpvotes = myPosts.reduce((sum, post) => sum + (post.upvotes || 0), 0);

    document.getElementById('statPosts').textContent = myPosts.length;
    document.getElementById('statUpvotes').textContent = totalUpvotes; // ‚Üê Fixed: removed .length
    document.getElementById('statFavorites').textContent = (currentUser.favorites && currentUser.favorites.length) ? currentUser.favorites.length : 0;
}

        async function fetchMyReviews() {
            // Fetch reviews created by the logged-in user from the server
            try {
                const res = await fetch('/api/my_reviews');
                const data = await res.json();
                if (data && data.success) {
                    currentUser.myPosts = data.reviews || [];
                } else {
                    currentUser.myPosts = [];
                }
            } catch (e) {
                console.warn('Could not fetch my reviews', e);
                currentUser.myPosts = [];
            }
        }

        // helper: fetch reviews by ids via backend endpoint
        async function fetchReviewsByIds(ids) {
            if (!Array.isArray(ids) || ids.length === 0) return [];
            try {
                const res = await fetch(`/api/reviews_by_ids?ids=${ids.join(',')}`);
                const d = await res.json();
                if (d && d.success) return d.reviews || [];
            } catch (e) {
                console.warn('fetchReviewsByIds failed', e);
            }
            return [];
        }

        function loadProfilePosts() {
            const myPostsGrid = document.getElementById('myPostsGrid');
            const myFavoritesGrid = document.getElementById('myFavoritesGrid');
            const upvotedGrid = document.getElementById('upvotedGrid');

            myPostsGrid.innerHTML = '';
            myFavoritesGrid.innerHTML = '';
            upvotedGrid.innerHTML = '';

            const myPosts = Array.isArray(currentUser.myPosts) ? currentUser.myPosts : [];
            myPosts.forEach(post => {
                myPostsGrid.appendChild(createPostCard(post));
            });

            // Favorites: try to find in myPosts, otherwise look in _extraPosts (fetched above)
            const favIds = currentUser.favorites || [];
            const favCandidates = [...(myPosts || []), ...(currentUser._extraPosts || [])];
            favIds.forEach(id => {
                const post = favCandidates.find(p => p.id === id);
                if (post) myFavoritesGrid.appendChild(createPostCard(post));
            });

            // Upvoted: these may be posts by other users, so check extra posts too
            const upvIds = currentUser.upvotedPosts || [];
            const upvCandidates = [...(myPosts || []), ...(currentUser._extraPosts || [])];
            upvIds.forEach(id => {
                const post = upvCandidates.find(p => p.id === id);
                if (post) upvotedGrid.appendChild(createPostCard(post));
            });
        }

        function switchProfileTab(tabName) {
            document.querySelectorAll('.profile-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Use event.target if available (from a click), otherwise use the function for manual setting
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback for cases where an event is not directly triggering this (like initial load)
                const targetButton = document.querySelector(`.profile-tabs button[onclick*="'${tabName}'"]`);
                if (targetButton) {
                    targetButton.classList.add('active');
                }
            }

            document.getElementById(tabName).classList.add('active');
        }
        function switchProfileTabManual(tabName) {
            document.querySelectorAll('.profile-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Find and activate the correct button/tab
            const targetButton = document.querySelector(`.profile-tabs button[onclick*="'${tabName}'"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }

            // Activate the correct content pane
            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }
        function showFavorites() {
            if (!isLoggedIn) {
                openAuthModal();
                return;
            }
            showProfile('myFavorites');
        }

        function loadPosts() {
            const postsGrid = document.getElementById('postsGrid');
            postsGrid.innerHTML = '';

            // Fetch reviews for the current canteen from the server
            if (!currentCanteenId) return;

            fetch(`/api/canteen_reviews?canteen_id=${encodeURIComponent(currentCanteenId)}`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.success) {
                        data.reviews.forEach(post => {
                            const postCard = createPostCard(post);
                            postsGrid.appendChild(postCard);
                        });
                    } else {
                        console.warn('Could not load reviews', data);
                    }
                }).catch(err => console.error('Error fetching reviews', err));
        }

        function createPostCard(post) {
            const card = document.createElement('div');
            card.className = 'post-card';
            
            const stars = '‚òÖ'.repeat(post.rating) + '‚òÜ'.repeat(5 - post.rating);
            const chilies = 'üå∂Ô∏è'.repeat(post.spiceLevel);
            
            // server uses `id` for ReviewID
            const isUpvoted = currentUser.upvotedPosts.includes(post.id);
            const isFavorited = currentUser.favorites.includes(post.id);
            
            const images = post.images || [post.image];
            const imageGalleryHtml = images.length > 1 ? `
                <div style="position: relative;">
                    <img src="${images[0]}" alt="${post.name}" class="post-image" id="mainImg-${post.id}">
                    <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 15px; color: #fff; font-size: 12px;">
                        1/${images.length}
                    </div>
                    ${images.length > 1 ? `
                        <button onclick="changeImage(${post.id}, -1)" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: #fff; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px;">‚Äπ</button>
                        <button onclick="changeImage(${post.id}, 1)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: #fff; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px;">‚Ä∫</button>
                    ` : ''}
                    <div style="display: flex; gap: 5px; padding: 10px; overflow-x: auto; background: #1a1a1a;">
                        ${images.map((img, idx) => `
                            <img src="${img}" onclick="setImage(${post.id}, ${idx})" style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px; cursor: pointer; border: 2px solid ${idx === 0 ? '#ff9800' : '#333'};" class="thumb-${post.id}" data-index="${idx}">
                        `).join('')}
                    </div>
                </div>
            ` : `<img src="${images[0]}" alt="${post.name}" class="post-image">`;
            
            card.innerHTML = `
                ${imageGalleryHtml}
                <div class="post-content">
                    <h3 class="post-title">${post.name}</h3>
                    <div class="post-details">
                        <span style="color: #ff9800;">${stars}</span>
                        <span>‚Çπ${post.price}</span>
                        <span>${chilies || 'ü•õ'}</span>
                    </div>
                    <p style="color: #ccc; font-size: 0.9rem; margin-bottom: 10px;">${post.review}</p>
                    <p style="color: #999; font-size: 0.8rem; margin: 0;">by ${post.author}</p>
                    <div class="post-actions">
                        <button class="action-btn ${isUpvoted ? 'upvoted' : ''}" onclick="upvotePost(${post.id}, this)">
                            ‚Üë ${post.upvotes}
                        </button>
                        <button class="action-btn ${isFavorited ? 'favorited' : ''}" onclick="toggleFavorite(${post.id}, this)">
                            ${isFavorited ? '‚òÖ' : '‚òÜ'}
                        </button>
                        ${ (isLoggedIn && currentUser.id === post.author_id) ? `<button class="action-btn" style="background:#ff4444; padding:8px 10px; font-size:14px;" onclick="deleteReview(${post.id})">Delete</button>` : '' }
                        <button class="action-btn comment-btn" onclick="toggleComments(${post.id})">
                            üí¨ ${post.comments.length}
                        </button>
                    </div>
                    <div class="comments-section" id="comments-${post.id}">
                        <div id="commentsList-${post.id}">
                            ${post.comments.map(c => `
                                <div class="comment-item" id="comment-${c.id}">
                                    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                                        <div class="comment-author">${c.author}</div>
                                        ${ (isLoggedIn && currentUser.id === c.user_id) ? `<button class="action-btn" style="background:#ff4444; padding:6px 8px; font-size:12px;" onclick="deleteComment(${c.id}, ${post.id})">Delete</button>` : '' }
                                    </div>
                                    <div class="comment-text">${c.text}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="comment-input-group">
                            <input type="text" class="comment-input" id="commentInput-${post.id}" placeholder="Add a comment...">
                            <button class="action-btn" onclick="addComment(${post.id})">Post</button>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        function upvotePost(postId, btn) {
            if (!isLoggedIn) {
                showToast('Please sign in to upvote posts!', 'warning');
                openAuthModal();
                return;
            }

            // Send toggle request to server
            fetch(`/upvote/${postId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (!data || !data.success) {
                        const msg = data && data.error ? data.error : 'Upvote failed';
                        showToast(msg, 'error');
                        console.warn('Upvote failed', data);
                        return;
                    }

                    // Update button UI: text and class
                    if (btn) {
                        btn.classList.toggle('upvoted', !!data.upvoted);
                        btn.textContent = `‚Üë ${data.upvotes}`;
                    }

                    // Show toast feedback
                    if (data.upvoted) {
                        showToast('Upvoted', 'success');
                    } else {
                        showToast('Upvote removed', 'info');
                    }

                    // update currentUser.upvotedPosts array
                    const idx = currentUser.upvotedPosts.indexOf(postId);
                    if (data.upvoted && idx === -1) currentUser.upvotedPosts.push(postId);
                    if (!data.upvoted && idx > -1) currentUser.upvotedPosts.splice(idx, 1);

                    // Re-fetch authoritative user state & reviews to ensure UI matches DB
                    Promise.all([
                        fetch('/api/me').then(r => r.json()).catch(() => null),
                        fetch('/api/my_reviews').then(r => r.json()).catch(() => null)
                    ]).then(([meData, reviewsData]) => {
                        if (meData && meData.logged_in) {
                            currentUser.id = meData.user_id || currentUser.id;
                            currentUser.username = meData.username || currentUser.username;
                            currentUser.profilePic = meData.profile_image_url || currentUser.profilePic;
                            currentUser.favorites = meData.favorites || currentUser.favorites || [];
                            currentUser.upvotedPosts = meData.upvoted || currentUser.upvotedPosts || [];
                        }

                        if (reviewsData && reviewsData.success) {
                            currentUser.myPosts = reviewsData.reviews || [];
                        }

                        try { updateProfileStats(); } catch (e) {}
                        try { loadProfilePosts(); } catch (e) {}
                    }).catch((e) => {
                        // best-effort fallback: update local cached counts
                        try { updateProfileStats(); } catch (e) {}
                    });
                }).catch(err => {
                    console.error('Error toggling upvote', err);
                    showToast('You cannot upvote your own post', 'error');
                });
        }

        function toggleFavorite(postId, btn) {
            if (!isLoggedIn) {
                showToast('Please sign in to favorite posts!', 'warning');
                openAuthModal();
                return;
            }

            fetch(`/favorite/${postId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (!data || !data.success) {
                        const msg = data && data.error ? data.error : 'Favorite action failed';
                        showToast(msg, 'error');
                        console.warn('Favorite toggle failed', data);
                        return;
                    }

                    if (btn) {
                        btn.classList.toggle('favorited', !!data.favorited);
                        btn.textContent = data.favorited ? '‚òÖ' : '‚òÜ';
                    }

                    // Show toast for user feedback
                    if (data.favorited) {
                        showToast('Added to favorites', 'success');
                    } else {
                        showToast('Removed from favorites', 'info');
                    }

                    const idx = currentUser.favorites.indexOf(postId);
                    if (data.favorited && idx === -1) currentUser.favorites.push(postId);
                    if (!data.favorited && idx > -1) currentUser.favorites.splice(idx, 1);

                    // Re-fetch authoritative user state & reviews to ensure UI matches DB
                    Promise.all([
                        fetch('/api/me').then(r => r.json()).catch(() => null),
                        fetch('/api/my_reviews').then(r => r.json()).catch(() => null)
                    ]).then(([meData, reviewsData]) => {
                        if (meData && meData.logged_in) {
                            currentUser.id = meData.user_id || currentUser.id;
                            currentUser.username = meData.username || currentUser.username;
                            currentUser.profilePic = meData.profile_image_url || currentUser.profilePic;
                            currentUser.favorites = meData.favorites || currentUser.favorites || [];
                            currentUser.upvotedPosts = meData.upvoted || currentUser.upvotedPosts || [];
                        }

                        if (reviewsData && reviewsData.success) {
                            currentUser.myPosts = reviewsData.reviews || [];
                        }

                        try { updateProfileStats(); } catch (e) {}
                        try { loadProfilePosts(); } catch (e) {}
                    }).catch((e) => {
                        try { updateProfileStats(); } catch (e) {}
                    });
                }).catch(err => {
                    console.error('Error toggling favorite', err);
                    showToast('You cannot add your post to favorites', 'error');
                });
        }

        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            if (commentsSection.style.display === 'block') {
                commentsSection.style.display = 'none';
            } else {
                commentsSection.style.display = 'block';
            }
        }

        function addComment(postId) {
    if (!isLoggedIn) {
        showToast('Please sign in to comment!', 'warning');
        openAuthModal();
        return;
    }

    const input = document.getElementById(`commentInput-${postId}`);
    const commentText = input.value.trim();
    
    if (!commentText) {
        showToast('Please enter a comment!', 'warning');
        return;
    }

    // Send comment to server
    const formData = new FormData();
    formData.append('comment', commentText);

    fetch(`/comment/${postId}`, {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
            if (data && data.success) {
            showToast('Comment posted successfully', 'success');
            input.value = '';
            
            // Reload posts to show the new comment
            if (document.getElementById('canteenPage').style.display === 'block') {
                loadPosts();
            } else if (document.getElementById('profilePage').style.display === 'block') {
                loadProfilePosts();
            }
        } else {
            showToast('Failed to post comment: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(err => {
        console.error('Error posting comment:', err);
        showToast('Failed to post comment. Please try again.', 'error');
    });
}

        // Delete a comment owned by the current user
        function deleteComment(commentId, postId) {
            if (!isLoggedIn) {
                showToast('Please sign in to delete comments!', 'warning');
                openAuthModal();
                return;
            }

            if (!confirm('Delete this comment?')) return;

            fetch(`/comment/${commentId}/delete`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data && data.success) {
                        // If canteen view is open, reload posts; if profile view is open, reload profile posts
                        if (document.getElementById('canteenPage').style.display === 'block') {
                            loadPosts();
                        } else if (document.getElementById('profilePage').style.display === 'block') {
                            loadProfilePosts();
                        } else {
                            // remove the comment element from DOM as a fallback
                            const el = document.getElementById(`comment-${commentId}`);
                            if (el) el.remove();
                        }
                    } else {
                        showToast('Failed to delete comment: ' + (data && data.error ? data.error : 'Unknown error'), 'error');
                    }
                }).catch(err => {
                    console.error('Error deleting comment', err);
                    showToast('Failed to delete comment. Please try again.', 'error');
                });
        }

        // Delete a review (post) owned by the current user
        function deleteReview(reviewId) {
            if (!isLoggedIn) {
                showToast('Please sign in to delete reviews!', 'warning');
                openAuthModal();
                return;
            }

            if (!confirm('Delete this review? This action cannot be undone.')) return;

            fetch(`/review/${reviewId}/delete`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data && data.success) {
                        // If canteen view is open, reload posts; if profile view is open, reload profile posts
                        if (document.getElementById('canteenPage').style.display === 'block') {
                            loadPosts();
                        } else if (document.getElementById('profilePage').style.display === 'block') {
                            loadProfilePosts();
                        } else {
                            // remove the post element from DOM as a fallback
                            const el = document.querySelector(`.post-card[data-id="${reviewId}"]`);
                            if (el) el.remove();
                            // also try to reload lists
                            try { loadPosts(); } catch (e) {}
                        }
                    } else {
                        showToast('Failed to delete review: ' + (data && data.error ? data.error : 'Unknown error'), 'error');
                    }
                }).catch(err => {
                    console.error('Error deleting review', err);
                    showToast('Failed to delete review. Please try again.', 'error');
                });
        }

        function openUploadModal() {
            if (!isLoggedIn) {
                showToast('Please sign in to upload reviews!', 'warning');
                openAuthModal();
                return;
            }
            document.getElementById('uploadModal').style.display = 'block';
            setTimeout(() => {
                initializeRatingSystem();
            }, 100);
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            resetUploadForm();
        }

        function resetUploadForm() {
            document.getElementById('uploadForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            currentRating = 0;
            currentSpiceLevel = 0;
            updateStarDisplay();
            updateSpiceDisplay();
        }

        function initializeRatingSystem() {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    currentRating = parseInt(this.dataset.rating);
                    updateStarDisplay();
                });
                
                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
            });
            
            document.getElementById('ratingStars').addEventListener('mouseleave', function() {
                updateStarDisplay();
            });

            const chilies = document.querySelectorAll('.chili');
            chilies.forEach(chili => {
                chili.addEventListener('click', function() {
                    currentSpiceLevel = parseInt(this.dataset.spice);
                    updateSpiceDisplay();
                });
            });
        }

        function updateStarDisplay() {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                star.classList.toggle('active', index < currentRating);
            });
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                star.classList.toggle('active', index < rating);
            });
        }

        function updateSpiceDisplay() {
            const chilies = document.querySelectorAll('.chili');
            chilies.forEach((chili, index) => {
                chili.classList.toggle('active', index < currentSpiceLevel);
            });
        }

        function handleImagePreview() {
            const fileInput = document.getElementById('foodImage');
            const imagePreview = document.getElementById('imagePreview');
            
            fileInput.addEventListener('change', function(e) {
                imagePreview.innerHTML = '';
                const files = Array.from(e.target.files);
                
                if (files.length > 5) {
                    showToast('You can upload maximum 5 images!', 'warning');
                    fileInput.value = '';
                    return;
                }
                
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const imgContainer = document.createElement('div');
                        imgContainer.style.position = 'relative';
                        imgContainer.style.borderRadius = '8px';
                        imgContainer.style.overflow = 'hidden';
                        
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.width = '100%';
                        img.style.height = '100px';
                        img.style.objectFit = 'cover';
                        img.style.border = '2px solid #ff9800';
                        img.style.borderRadius = '8px';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.innerHTML = '√ó';
                        removeBtn.style.position = 'absolute';
                        removeBtn.style.top = '5px';
                        removeBtn.style.right = '5px';
                        removeBtn.style.background = '#ff4444';
                        removeBtn.style.color = '#fff';
                        removeBtn.style.border = 'none';
                        removeBtn.style.borderRadius = '50%';
                        removeBtn.style.width = '25px';
                        removeBtn.style.height = '25px';
                        removeBtn.style.cursor = 'pointer';
                        removeBtn.style.fontSize = '18px';
                        removeBtn.style.fontWeight = 'bold';
                        removeBtn.onclick = function(e) {
                            e.preventDefault();
                            imgContainer.remove();
                            const dt = new DataTransfer();
                            const currentFiles = Array.from(fileInput.files);
                            currentFiles.forEach((f, i) => {
                                if (f.name !== file.name) dt.items.add(f);
                            });
                            fileInput.files = dt.files;
                        };
                        
                        imgContainer.appendChild(img);
                        imgContainer.appendChild(removeBtn);
                        imagePreview.appendChild(imgContainer);
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

       function initializeFormSubmission() {
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        handleImagePreview();
        
        uploadForm.addEventListener('submit', function(e) {
            // Validate client-side
            const foodName = document.getElementById('foodName').value;
            const price = document.getElementById('price').value;

            if (currentRating === 0) {
                e.preventDefault();
                showToast('Please select a rating!', 'warning');
                return;
            }

            if (!foodName || !price) {
                e.preventDefault();
                showToast('Please fill in all required fields!', 'warning');
                return;
            }

            if (!currentCanteenId) {
                e.preventDefault();
                showToast('Please open a canteen first before submitting a review!', 'warning');
                return;
            }

            // Populate hidden inputs
            document.getElementById('ratingInput').value = currentRating;
            document.getElementById('spiceInput').value = currentSpiceLevel;
            document.getElementById('canteenIdInput').value = currentCanteenId || '';

            // Debug: print the final form data to the browser console
            try {
                const fd = new FormData(uploadForm);
                const entries = {};
                for (const [k,v] of fd.entries()) {
                    // For files, show filename(s)
                    if (v instanceof File) {
                        entries[k] = v.name;
                    } else {
                        entries[k] = v;
                    }
                }
                console.log('Submitting review form data:', entries);
            } catch (e) { console.warn('Could not log form data', e); }

            // Allow form to submit naturally (will cause page reload)
            // The form will POST to /submit_review and Flask will redirect
        });
    }
}

        function initializeAuthForms() {
            // The sign-in and register forms now submit to the server via regular POST.
            // We intentionally avoid intercepting the submit event here so Flask's
            // /login and /register routes handle persistence to MySQL.
        }
        
        // NEW FUNCTION: Handle Profile Picture Change
        function handleProfilePicChange() {
            const input = document.getElementById('changeProfilePicInput');
            const profileAvatar = document.getElementById('profileAvatar');
            const profileImgNavbar = document.getElementById('profileImg');
            
            if (!input) return; // Exit if the element isn't on the page (e.g., if code is run before DOM is ready)

            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const newPicUrl = event.target.result;
                        
                        // 1. Update the currentUser data
                        currentUser.profilePic = newPicUrl;
                        
                        // 2. Update all visible elements
                        profileImgNavbar.src = newPicUrl; // Navbar
                        profileAvatar.src = newPicUrl; // Profile Page Avatar
                        
                        showToast('Profile picture updated successfully!', 'success');
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
        }
        // END NEW FUNCTION

        document.addEventListener('DOMContentLoaded', function() {
        initializeFormSubmission();
        initializeAuthForms();
        
        // INITIALIZE THE NEW FUNCTION
        handleProfilePicChange(); 
        // END INITIALIZE THE NEW FUNCTION
        
        document.getElementById('sortFilter').addEventListener('change', function() {
        const sortBy = this.value;
        if (sortBy) {
            sortPosts(sortBy);
        } else {
            // If "Sort by" is selected (empty value), reload all posts unsorted
            loadPosts();
        }
    });

            document.getElementById('profileImg').addEventListener('click', function() {
                toggleAuth();
            });
            
            // If logged in on the server side, fetch authoritative user state
            if (typeof SERVER !== 'undefined' && SERVER.loggedIn) {
                fetch('/api/me').then(r => r.json()).then(data => {
                    if (data && data.logged_in) {
                        currentUser.id = data.user_id || currentUser.id;
                        currentUser.username = data.username || currentUser.username;
                        currentUser.profilePic = data.profile_image_url || currentUser.profilePic;
                        currentUser.favorites = data.favorites || [];
                        currentUser.upvotedPosts = data.upvoted || [];

                        // Now fetch the user's reviews from the server and render profile
                        fetchMyReviews().then(() => {
                            try { updateProfileStats(); } catch (e) {}
                            try { loadProfilePosts(); } catch (e) {}
                        });
                    }
                }).catch(err => console.warn('Could not fetch /api/me', err));
            }
        });
        let currentImageIndex = {};

        function changeImage(postId, direction) {
            const post = samplePosts.find(p => p.id === postId);
            if (!post || !post.images) return;
            
            if (!currentImageIndex[postId]) currentImageIndex[postId] = 0;
            
            currentImageIndex[postId] = (currentImageIndex[postId] + direction + post.images.length) % post.images.length;
            
            const mainImg = document.getElementById(`mainImg-${postId}`);
            if (mainImg) {
                mainImg.src = post.images[currentImageIndex[postId]];
                mainImg.parentElement.querySelector('div[style*="bottom: 10px"]').textContent = `${currentImageIndex[postId] + 1}/${post.images.length}`;
                
                document.querySelectorAll(`.thumb-${postId}`).forEach((thumb, idx) => {
                    thumb.style.border = idx === currentImageIndex[postId] ? '2px solid #ff9800' : '2px solid #333';
                });
            }
        }

        function setImage(postId, index) {
            currentImageIndex[postId] = index;
            changeImage(postId, 0);
        }

        function sortPosts(sortBy) {
    if (!currentCanteenId) return;
    
    // Map frontend sort keys to backend sort keys
    const sortMapping = {
        'upvotes': 'upvotes',
        'popular': 'popular',
        'spice': 'spice_desc',
        'recent': 'newest',
        'price': 'price_asc'
    };
    
    const backendSortKey = sortMapping[sortBy] || '';
    
    // Fetch sorted reviews from the server
    const postsGrid = document.getElementById('postsGrid');
    postsGrid.innerHTML = '<p style="text-align: center; color: #ccc;">Loading...</p>';
    
    fetch(`/api/canteen_reviews?canteen_id=${encodeURIComponent(currentCanteenId)}&sort=${encodeURIComponent(backendSortKey)}`)
        .then(res => res.json())
        .then(data => {
            postsGrid.innerHTML = '';
            if (data && data.success) {
                data.reviews.forEach(post => {
                    const postCard = createPostCard(post);
                    postsGrid.appendChild(postCard);
                });
            } else {
                postsGrid.innerHTML = '<p style="text-align: center; color: #ccc;">No reviews found</p>';
            }
        })
        .catch(err => {
            console.error('Error fetching sorted reviews:', err);
            postsGrid.innerHTML = '<p style="text-align: center; color: #ff4444;">Error loading reviews</p>';
        });
    }
    </script>
</body>
</html>